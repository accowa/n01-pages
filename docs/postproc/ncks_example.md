# Running multiple ncks commands simultaneously

For small to medium sized NEMO configurations the 'one_file' option with XIOS is
a convenient way to avoid creating too many output files. However, since the
XIOS servers use NetCDF's parallel I/O capabilities to write to the single
files, this precludes sensible chunking and compression settings. A recommended
post-processing step is to chunk and compress the output files to help preserve
the consortium's limited disk space.

The standard ncks tool will do this well enough but a single batch job may have
generated many files that need to be processed. Running the ncks utility
serially on the output will take too long and is a very poor use of a 128-core
node.

Take the example of an eORCA1 run with biogeochemistry which can generate 30
years worth of annual and monthly mean datasets in a 10 hour run. In the case of
the monthly mean files there are 9 files per month ranging from small (poleward
transport diagnostics) to very large (biogeochemical diagnostics). One sensible
way to process these is in a triple-nested loop over year then file-type then
month. That way 12, roughly equal files can be processed simultaneously and each
member of the 12 should complete is a similar time.

Now a single ncks command would be something like:

```
ncks --no_abc --cnk_dmn x,64 --cnk_dmn y,64 --cnk_dmn deptht,1 --cnk_dmn time_counter,1 --dfl_lvl 1 \  
         eORCA1_MED_UKESM_1m_18500101_18791230_ptrc_T_185001-185001.nc \
         $out_dir/1850/eORCA1_MED_UKESM_y1850m01_ptrc_T.nc
```

where the opportunity has also been taken to prune redundant parts of the
filename to create a more concise output filename. To run 12 copies of a similar
command simultaneously on a node requires two simple steps:

First, create a task-list file of the 12 commands preceded by a zero-based task number, e.g.:

```
cat tasks.conf
0 ncks --no_abc --cnk_dmn x,64 --cnk_dmn y,64 --cnk_dmn deptht,1 --cnk_dmn time_counter,1 --dfl_lvl 1 \  
           eORCA1_MED_UKESM_1m_18500101_18791230_ptrc_T_185001-185001.nc \
           $out_dir/1850/eORCA1_MED_UKESM_y1850m01_ptrc_T.nc
1 ncks --no_abc --cnk_dmn x,64 --cnk_dmn y,64 --cnk_dmn deptht,1 --cnk_dmn time_counter,1 --dfl_lvl 1 \ 
           eORCA1_MED_UKESM_1m_18500101_18791230_ptrc_T_185002-185002.nc \
           $out_dir/1850/eORCA1_MED_UKESM_y1850m02_ptrc_T.nc
2 ncks --no_abc --cnk_dmn x,64 --cnk_dmn y,64 --cnk_dmn deptht,1 --cnk_dmn time_counter,1 --dfl_lvl 1 \ 
           eORCA1_MED_UKESM_1m_18500101_18791230_ptrc_T_185003-185003.nc \
           $out_dir/1850/eORCA1_MED_UKESM_y1850m03_ptrc_T.nc
.
.
.
10 ncks --no_abc --cnk_dmn x,64 --cnk_dmn y,64 --cnk_dmn deptht,1 --cnk_dmn time_counter,1 --dfl_lvl 1 \ 
           eORCA1_MED_UKESM_1m_18500101_18791230_ptrc_T_185011-185011.nc \
           $out_dir/1850/eORCA1_MED_UKESM_y1850m11_ptrc_T.nc
11 ncks --no_abc --cnk_dmn x,64 --cnk_dmn y,64 --cnk_dmn deptht,1 --cnk_dmn time_counter,1 --dfl_lvl 1 
           eORCA1_MED_UKESM_1m_18500101_18791230_ptrc_T_185012-185012.nc \
           $out_dir/1850/eORCA1_MED_UKESM_y1850m12_ptrc_T.nc

```

Secondly, submit a 'multi_prog' script with appropriate core placement. Here,
for example, I have used mkslurm to generate placement for 12 tasks with each task
spaced 8 cores apart:
```
#!/bin/bash
.
#SBATCH --nodes=1	
#SBATCH --ntasks=12
# Based on placement generated by: mkslurm -S 0 -s 0 -C 12 -c 8
.
 srun --ntasks=12 --mem-bind=local \
      --cpu-bind=v,map_cpu:00,0x8,0x10,0x18,0x20,0x28,0x30,0x38,0x40,0x48,0x50,0x58 \
      --multi-prog tasks.conf
.
```

This script will process one year of monthly means from the aforementioned configuration
in around 2 minutes. Thus, this single-node solution is more than sufficient to keep up
with production.

The full script, complete with loops and logic to generate and execute a succession of
task-lists, can be viewed [here](ncks_script.md).


