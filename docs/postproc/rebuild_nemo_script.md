# Example rebuild_nemo submission script

```
#!/bin/bash
#SBATCH --qos=standard
#SBATCH --job-name=mreb_1m
#SBATCH --time=03:00:00
#SBATCH --nodes=2
#SBATCH --ntasks=12
#SBATCH --ntasks-per-node=6
#SBATCH --account=n01
#SBATCH --partition=standard
# Based on placement generated by: mkslurm -S 0 -s 0 -C 12 -c 16
#
module -s restore /work/n01/shared/acc/n01_modules/ucx_env
export PATH=/work/n01/n01/acc/TOOLS/bin:$PATH
export LD_LIBRARY_PATH=/work/n01/n01/acc/TOOLS/lib:$LD_LIBRARY_PATH
export OMP_NUM_THREADS=4
##################################################################################
#
# Parallel rebuild of multiple_file XIOS output from eORCA025
#
# This script is configured to rebuild the eORCA025 output generated with 16
# detached XIOS servers. It uses the standard rebuild_nemo tool with 12 instances
# running simultaneously across two nodes. Each instance occupies a 16 core NUMA
# and uses 4 OpenMP threads. There has been little investigation to find if this
# optimal but it works and recombines a years worth of monthly mean output in
# around 20 minutes (including some very large biogeochemical datasets)
#
# The loop order is: year -> filetype -> month so that each invocation of 12
# parallel tasks delivers a years worth of monthly means for that filetype with
# each of the 12 tasks having a similar load and completing in roughly the
# same length of time
#
###################################################################################
#
# Define the destination directory (annual subdirectories will be created below this)
#
  dstdir=/work/n01/n01/acc/NEMO/OUT_eORCA025/A001/monthly
#
# Define the data directory containing the distributed mean fields
#
  dtadir=/work/n01/n01/acc/NEMO/r4.0.3/dev_r4.0.3_NERC/cfgs/ORCA025_MEDUSA/EXP00/MEANS_OUT
#
# Set the number of distributed datasets to combine ( = number of XIOS servers )
#
  export NUMP=16
#
# Provide absolute path to the rebuild_nemo executable/script and a base name for its namelist
#
  reb=/work/n01/n01/acc/NEMO/r4.0.3/dev_r4.0.3_NERC/tools/REBUILD_NEMO/rebuild_nemo
  nlfile=reb$$.nl
#
# Set the start and end years of the sequence to process
#
  ystart=1853
  yend=1856
#
# Define a recyclable file to hold the tasklist and the launch directory
#
tsklst=$dstdir/tasks.conf
tskdir=`pwd`
#
cd $dtadir
#
# Loop through each year
#
for y in `seq $ystart 1 $yend`
do
 #
 # Loop through each type of dataset (expand or contract as required)
 #
 for typ in icemod grid_T grid_U grid_V grid_W diad_T ptrc_T
 do
  if [ -f $tsklst ] ; then rm $tsklst ; fi
  n=0
  #
  # Loop through each month (do not extend beyond 12)
  #
  for m in 01 02 03 04 05 06 07 08 09 10 11 12
  do
   #
   # find the basename for this year/type/month combination
   # (there should only be one match - do not really need a loop here)
   #
   for fin in `ls -1 e*_1m_*${typ}*${y}${m}_0000.nc`
   do
     f=`echo $fin | sed -e's/_0000.nc//'`
     if [ ! -d ${dstdir}/$y ] ; then mkdir ${dstdir}/$y ; fi
     #
     # Construct a more concise output filename
     #
     if [ $f == ${f/icemod} ] && [ $f == ${f/diaptr} ]; then
       ff=`echo $f | sed -e's/\(.*\)1m_\(........_........\)\(_[a-zA-Z]*_[a-zA-Z]*\)_.*-\(....\)\(..\)/\1y\4m\5\3.nc/'`
     else
       ff=`echo $f | sed -e's/\(.*\)1m_\(........_........\)\(_[a-zA-Z23]*\)_.*-\(....\)\(..\)/\1y\4m\5\3.nc/'`
     fi
     #
     # If to be processed, then append the full rebuild command to the task list
     #
     if [ ! -f ${dstdir}/$y/$ff ] ; then
       echo $n $reb -n ${n}_$nlfile -p $OMP_NUM_THREADS -d 1 -x 64 -y 64 -z 1 -t 1 $f $NUMP >> $tsklst
       #
       # rebuild_nemo doe not allow us to set the output filename. Store what is used, what we want it
       # to be (including final destination) and the namelist file (so that it can be tidied later)
       #
       fcomb[$n]=$f.nc
       frenm[$n]=${dstdir}/$y/$ff
       fnlfi[$n]=${n}_$nlfile
       n=$(( $n + 1 ))
     fi
   done
  #
  # End of scan through months
  #
  done
  #
  # A tasklist of up to 12 tasks has been constructed; check its length
  #
  if [ -f $tsklst ] ; then
   nt=`wc -l $tsklst | sed -e 's/ .*//'`
  else
   nt=0
  fi
  #
  # Run any non-zero length tasklist using srun and appropriate placement
  #
  if test $nt -gt 0 ; then
   srun --ntasks=$nt --mem-bind=local --cpu-bind=v,map_cpu:00,0x10,0x20,0x30,0x40,0x50 --multi-prog $tsklst
   #
   # On completion the combined files have the wrong names and are still in the data directory
   # Use the stored arrays to move/rename them and remove the temporary namelist files
   #
   for k in `seq 0 1 $(( $nt - 1 ))`
   do
    if [ -f ${fcomb[$k]} ] ; then mv ${fcomb[$k]} ${frenm[$k]} ; fi
    if [ -f ${fnlfi[$k]} ] ; then rm ${fnlfi[$k]} ; fi
   done
  fi
 #
 # End of file-type loop
 #
 done
#
# End of year loop
#
done
#
cd $tskdir
```
